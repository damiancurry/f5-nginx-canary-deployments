resources:
  - name: gitRepo
    type: GitRepo
    configuration:
      path: damiancurry/f5-nginx-canary-deployments
      gitProvider: dcurry_github
      branches:
        include: master
  - name: demo_app_image
    type: Image
    configuration:
      registry: PartnershipArtifactory
      sourceRepository: demo-docker-local
      imageName: f5swampup.jfrog.io/artifactory/demo-app
      imageTag: ${run_number}
      autoPull: true
  - name: demo_build_info
    type: Buildinfo
    configuration:
      sourceArtifactory: PartnershipArtifactory
      buildName: demo_build
      buildNumber: ${run_number}
  - name: promoted_demo_build_info
    type: Buildinfo
    configuration:
      sourceArtifactory: PartnershipArtifactory
      buildName: demo_build
      buildNumber: ${run_number}

pipelines:
      - name: eks_deploy
        type: Bash
        configuration:
          affinityGroup: kic_deploy
          integrations:
            - name: dcurryaws
            - name: dcurryeks
          inputResources:
            - name: gitRepo
          inputSteps:
            - name: docker_promote
        execution:
          onExecute:
            - cd $res_gitRepo_resourcePath
            - curl -o aws-iam-authenticator https://amazon-eks.s3.us-west-2.amazonaws.com/1.19.6/2021-01-05/bin/linux/amd64/aws-iam-authenticator
            - chmod +x ./aws-iam-authenticator
            - mkdir -p $HOME/bin && cp ./aws-iam-authenticator $HOME/bin/aws-iam-authenticator && export PATH=$PATH:$HOME/bin
            - sed "s|imageName|<update path to container image>:${run_number}|g" kic/deployment.yaml | sed "s|appname|frontend-app-${run_number}|g" | sed "s|svcname|frontend-app-svc-${run_number}|g" > my-deployment.yaml
            - kubectl apply -f my-deployment.yaml --namespace f5-nginx-canary-deployments
          onSuccess:
            - echo "Demo App ${run_number} service deployed!"
      - name: ingress_deploy
        type: Bash
        configuration:
          affinityGroup: kic_deploy
          inputSteps:
            - name: eks_deploy
          integrations:
            - name: dcurryaws
            - name: dcurryeks
          inputResources:
            - name: gitRepo
        execution:
          onExecute:
            - cd $res_gitRepo_resourcePath
            - curl -o aws-iam-authenticator https://amazon-eks.s3.us-west-2.amazonaws.com/1.19.6/2021-01-05/bin/linux/amd64/aws-iam-authenticator
            - chmod +x ./aws-iam-authenticator
            - mkdir -p $HOME/bin && cp ./aws-iam-authenticator $HOME/bin/aws-iam-authenticator && export PATH=$PATH:$HOME/bin
            - bash watch-update.sh $run_number frontend-app
          onSuccess:
            - echo "frontend-app release ${run_number} completed successfully"
          onFailure:
            - echo "release failed and has been rolled back.  Please check logs for detailed errors"